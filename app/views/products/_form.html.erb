<%= form_with(model: product, local: true) do |form| %>
  <% if product.errors.any? %>
    <div class="alert alert-danger">
      <h4>The following errors were found:</h4>
      <ul>
        <% product.errors.full_messages.each do |msg| %>
          <li><%= msg %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="form-group mb-3">
    <%= form.label :name, class: "form-label" %>
    <%= form.text_field :name, class: "form-control" %>
  </div>

  <div class="form-group mb-3">
    <%= form.label :discount, class: "form-label" %>
    <%= form.select :discount, options_for_select(Discounts.to_a, form.object.discount),
                    { include_blank: 'Select a discount...' },
                    class: "form-select" %>
  </div>

  <h4 class="mt-4 mb-3">Price on Gas Stations</h4>

  <div id="gas_station_products" class="mb-3">
    <%= form.fields_for :gas_station_products do |gsp_form| %>
      <div class="card mb-3 gas-station-product">
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-5">
              <%= gsp_form.label :gas_station_id, 'Posto', class: "form-label" %>
              <%= gsp_form.collection_select :gas_station_id, @gas_stations, :id, :name,
                                            { prompt: 'Select a gas station...' },
                                            class: "form-select" %>
            </div>
            <div class="col-md-5">
              <%= gsp_form.label :price_per_liter, 'Price per liter', class: "form-label" %>
              <div class="input-group">
                <span class="input-group-text">R$</span>
                <%= gsp_form.number_field :price_per_liter, step: 0.001, class: "form-control" %>
              </div>
            </div>
            <div class="col-md-2 d-flex align-items-end">
              <% if gsp_form.object.persisted? %>
                <div class="form-check form-switch">
                  <%= gsp_form.check_box :_destroy, class: "form-check-input" %>
                  <%= gsp_form.label :_destroy, 'Remove', class: "form-check-label" %>
                </div>
              <% else %>
                <button type="button" class="btn btn-outline-danger remove-product">
                  <i class="bi bi-trash"></i> Remove
                </button>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    <% end %>
  </div>

  <div class="mb-3">
    <button type="button" id="add_gas_station" class="btn btn-outline-primary">
      <i class="bi bi-plus"></i> Add Gas Station
    </button>
  </div>

  <div class="form-group mt-4">
    <%= form.submit "Save", class: "btn btn-primary" %>
    <%= link_to "Cancel", products_path, class: "btn btn-secondary" %>
  </div>
<% end %>

<template id="gas_station_product_template">
  <div class="card mb-3 gas-station-product">
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-5">
          <label class="form-label">Gas Station</label>
            <%= select_tag "product[gas_station_products_attributes][NEW_RECORD][gas_station_id]",
              options_from_collection_for_select(@gas_stations, :id, :name),
              include_blank: 'Select a gas station...',
              class: 'form-control' %>
        </div>
        <div class="col-md-5">
          <label class="form-label">Price per liter</label>
          <div class="input-group">
            <span class="input-group-text">R$</span>
            <input type="number" step="0.001" class="form-control"
                   name="product[gas_station_products_attributes][NEW_RECORD][price_per_liter]">
          </div>
        </div>
        <div class="col-md-2 d-flex align-items-end">
          <button type="button" class="btn btn-outline-danger remove-product">
            <i class="bi bi-trash"></i> Remove
          </button>
        </div>
      </div>
    </div>
  </div>
</template>


<script>
document.addEventListener('DOMContentLoaded', function() {
  const container = document.getElementById('gas_station_products');
  const template = document.getElementById('gas_station_product_template');
  const addButton = document.getElementById('add_gas_station');

  addButton.addEventListener('click', function() {
    const newField = template.content.cloneNode(true);
    const time = new Date().getTime();
    const html = newField.querySelector('.card').outerHTML.replace(/NEW_RECORD/g, time);
    container.insertAdjacentHTML('beforeend', html);
  });

  container.addEventListener('click', function(e) {
    if (e.target.closest('.remove-product')) {
      e.preventDefault();
      const productFields = container.querySelectorAll('.gas-station-product');
      if (productFields.length > 1) {
        e.target.closest('.gas-station-product').remove();
      } else {
        alert('At least one gas station product must remain.');
      }
    }
  })
})
</script>